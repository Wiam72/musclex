

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How it works &mdash; MuscleX  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How to use" href="Scanning-Diffraction--How-to-use.html" />
    <link rel="prev" title="Introduction" href="Scanning-Diffraction-(di).html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> MuscleX
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Muscle X</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Installation/index.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Application Suite</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Equator/index.html">Equator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../QuadrantFolding/index.html">Quadrant Folding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ProjectionTraces/index.html">Projection Traces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Scanning Diffraction</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Scanning-Diffraction-(di).html">Introduction</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">How it works</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#individual-image-mode">Individual Image Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#folder-mode">Folder Mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Scanning-Diffraction--How-to-use.html">How to use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ImageMerger/index.html">Image Merger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DiffractionCentroids/index.html">Diffraction Centroids</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DDFProcessor/index.html">DDF Processor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Calibration-Settings.html">Calibration Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Image-Processing-Functions.html">Image Processing Functions</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MuscleX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Application Suite</a> &raquo;</li>
        
          <li><a href="index.html">Scanning Diffraction</a> &raquo;</li>
        
      <li>How it works</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/AppSuite/ScanningDiffraction/Scanning-Diffraction--How-it-works.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-it-works">
<span id="how-it-works"></span><h1>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h1>
<p>There are 2 modes for Scanning Diffraction</p>
<ol class="simple">
<li><a class="reference external" href="#individual-image-mode">Individual Image Mode</a></li>
<li><a class="reference external" href="#folder-mode">Folder Mode / Batch Mode</a></li>
</ol>
<div class="section" id="individual-image-mode">
<span id="individual-image-mode"></span><h2>Individual Image Mode<a class="headerlink" href="#individual-image-mode" title="Permalink to this headline">¶</a></h2>
<p>When an image is selected, if there is an image in the same folder named “calibration.tif”, the <a class="reference external" href="https://github.com/rtfd/recommonmark/tree/master/doc/AppSuite\Calibration-Settings.html">calibration settings</a> the calibration settings window will pop up. If there’s no calibration image or it’s set already, the image will be processed automatically. However, if the image has ever been processed with the same version of the program, the cache will be downloaded, so the image won’t be processed again. Using a  calibration image or inputting the calibration information directly allows conversion of distance in pixels to d-spacings in nm. If calibration information is not provided, distances to diffraction rings are left in numbers of pixels.</p>
<p>To process an image, the program will go through multiple processes in the order:</p>
<div class="section" id="find-center">
<span id="find-center"></span><h3>1. <a class="reference external" href="https://github.com/rtfd/recommonmark/tree/master/doc/AppSuite\Image-Processing-Functions.html#finding-center">Find Center</a><a class="headerlink" href="#find-center" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="obtain-2d-integrated-intensities-and-1d-radial-integration">
<span id="obtain-2d-integrated-intensities-and-1d-radial-integration"></span><h3>2. Obtain 2D integrated intensities  and 1D Radial Integration<a class="headerlink" href="#obtain-2d-integrated-intensities-and-1d-radial-integration" title="Permalink to this headline">¶</a></h3>
<p>In this process, the program will obtain 2D and 1D radial integrated intensities  of the entire diffraction image  using the previously determined center. The program will use functions from the <a class="reference external" href="http://pyfai.readthedocs.io/en/latest/">pyFAI</a> library to produce the integrated intensity using FPGA hardware acceleration if available.  The 2D integrated intensity will be used for <a class="reference external" href="#4-find-rings-by-log-central-differences-method">Finding Rings by Log Central Differences Method</a> and 1D integrated intensity (after Convex Hull background subtraction is applied) will be used for <a class="reference external" href="#3-find-rings-by-partial-integration-method">Finding Rings by Partial Integration Method</a> and <a class="reference external" href="#6-fit-gaussian-models-to-1d-radial-integration">Fitting Model</a>.
For example, if the image is<br/>
<img alt="-" src="../../_images/image.png" /><br/>
The 2D radial integrated intensity map is ..<br/>
<img alt="-" src="../../_images/2d_int.png" /><br/>
and the 1D radial integrated map is ..<br/>
<img alt="-" src="../../_images/1d_int.png" /><br/></p>
</div>
<div class="section" id="find-rings-by-partial-integration-method">
<span id="find-rings-by-partial-integration-method"></span><h3>3. Find Rings by Partial Integration Method<a class="headerlink" href="#find-rings-by-partial-integration-method" title="Permalink to this headline">¶</a></h3>
<p>In order to find the ring locations, 2 methods are used, Partial Integration, and <a class="reference external" href="#3-find-rings-by-partial-integration-method">Central Difference</a>. In this process, <a class="reference external" href="http://pyfai.readthedocs.io/en/latest/">pyFAI</a> will be used to find the 1D integrated intensity a pie-shaped region around the center.   This angular range of this pie-shaped region can be specified by user with a  default of 90 degrees. Here are shown multiple 1D integrated intensity traces, one from each range, when the angle size is 90.</p>
<p><img alt="-" src="../../_images/partial.png" /></p>
<p>For each range, the program will try to find peak locations in the integrated intensity trace. The program will consider a peak as representing a ring when a peak appears at least one quarter of the number of angular ranges. For example, if there are 8 ranges and a peak appears in 2 ranges, this peak is considered a ring. However, if a peak does not appear in many ranges, but its area is large, it’s may also be considered as a ring.</p>
</div>
<div class="section" id="find-rings-by-log-central-differences-method">
<span id="find-rings-by-log-central-differences-method"></span><h3>4. Find Rings by Log Central Differences Method<a class="headerlink" href="#find-rings-by-log-central-differences-method" title="Permalink to this headline">¶</a></h3>
<p>This can be useful at locating weak peaks in the presence of strong ones in a pattern. In this process, the program will try to find rings by finding “runs”. First, 2D integration produces a 2D plot of pixel intensity as a function of angle and radius. Two additional images are generated by shifting the radius axis first left and then right by q0 pixels and te three images summed.  The result is shown on a logarithmic scale  After that, the program will go to each column and find “run:s. Runs are defined as columns of pixels containing values higher than the median in the image, and those pixels have similar value. Then, the rings will be considered from grouping runs. For example,</p>
<ul class="simple">
<li>2D integration<br/>
<img alt="-" src="../../_images/2d_int_th.png" /></li>
<li>After applying log central differences<br/>
<img alt="-" src="../../_images/m2_log.png" /></li>
<li>Finding runs (red lines)<br/>
<img alt="-" src="../../_images/m2_runs.png" /></li>
<li>Grouping runs to rings (white lines)<br/>
<img alt="-" src="../../_images/m2_rings.png" /></li>
</ul>
</div>
<div class="section" id="merge-rings">
<span id="merge-rings"></span><h3>5. Merge Rings<a class="headerlink" href="#merge-rings" title="Permalink to this headline">¶</a></h3>
<p>After the ring locations are calculated by 2 methods above, those rings will be merged in this process. Rings with similar distances will be averaged. For example, if the first method found rings at 50, 80, 118 pixels and the second method found rings at 82, 120, 180 pixels. The final rings will be at 50, 81, 119, 180 pixels.</p>
</div>
<div class="section" id="fit-gaussian-models-to-the-1d-radial-integrated-intensity">
<span id="fit-gaussian-models-to-the-1d-radial-integrated-intensity"></span><h3>6. Fit Gaussian Models to the 1D Radial Integrated intensity<a class="headerlink" href="#fit-gaussian-models-to-the-1d-radial-integrated-intensity" title="Permalink to this headline">¶</a></h3>
<p>In this process, multiple Gaussians will be fit to the 1D radially integrated intensity trace by using the ring locations as the initial centers for the Gaussians.</p>
<p><img alt="-" src="../../_images/fit_peaks.png" /></p>
<p>After fitting, we will get ..</p>
<ul class="simple">
<li>Distance from center to the ring</li>
<li>Standard deviation of the ring distribution in radial direction</li>
<li>Integrated area of the ring</li>
</ul>
</div>
<div class="section" id="finding-other-properties-of-each-ring">
<span id="finding-other-properties-of-each-ring"></span><h3>7. Finding Other Properties of Each Ring<a class="headerlink" href="#finding-other-properties-of-each-ring" title="Permalink to this headline">¶</a></h3>
<p>In this process, the program will go to each ring and obtain the angular projection of the ring. In the example above, these are 2 angular projections where the x-axis is the angle in radians and the y-axis is integrated intensity.
<img alt="-" src="../../_images/ang_proj.png" /></p>
<p>Then, 2 Gaussians will be fit to the projection to find the angle, and the angular range. The distance between the 2 Gaussian centers is assumed to be Pi radians.</p>
<p><img alt="-" src="../../_images/fit_rings.png" /></p>
<p>Finally, we will get …</p>
<ul class="simple">
<li>Orientation angle of the ring</li>
<li>Standard deviation of the orientation angle (Angle sigma)</li>
<li>Integrated area of the ring</li>
</ul>
<p>After everything is processed, results will be written to summary.csv and a different rings.csv  file. These files will be located in the folder cp results which is created under the folder containing the images. Currently, the file summary.csv contains the name of the image, the total diffracted intensity, and number of rings detected. In the rings.csv file, all information for all rings will be provided along with their fitting error. Note that there is no attempt made to index families of rings. Each ring is associated with its own unique d-spacing. The assumption is that the results data files will be processed by user supplied code to index the patterns.</p>
</div>
</div>
<div class="section" id="folder-mode">
<span id="folder-mode"></span><h2>Folder Mode<a class="headerlink" href="#folder-mode" title="Permalink to this headline">¶</a></h2>
<p>When a folder is selected, the program will get all image names in the folder, and check if all images have been processed by checking the summary.csv and rings.csv files. If there are some images which have not been processed, the program will process all those images using the <a class="reference external" href="#individual-image-mode">individual mode</a> first, and then generate maps from summary.csv and rings.csv.</p>
<p>In this mode, you will see 4 maps, Total Intensity Maps, Angular Range Maps, Orientation and Intensity Vector Field, and Elliptical Representation. Each pixel in the maps represents an individual diffraction image from the original image folder. To generate the maps, the program can use the  hdf data file generated by the BioCAT scanning diffraction imaging  script if it was used to  produce the image files. If there is no hdf file, one can be generated by providing start point in the X-direction and the X-pixel size and the start point in the Y direction and the Y-pixel size.</p>
<div class="section" id="total-intensity-maps">
<span id="total-intensity-maps"></span><h3>1. Total Intensity Maps<a class="headerlink" href="#total-intensity-maps" title="Permalink to this headline">¶</a></h3>
<p>Total intensity from summary.csv<br/>
<img alt="-" src="../../_images/map_int.png" /></p>
</div>
<div class="section" id="angular-range-maps">
<span id="angular-range-maps"></span><h3>2. Angular Range Maps<a class="headerlink" href="#angular-range-maps" title="Permalink to this headline">¶</a></h3>
<p>Value of Standard deviation of the orientation angle (Angle sigma) of <a class="reference external" href="#the-best-ring">the best ring</a> from rings.csv<br/>
<img alt="-" src="../../_images/map_ang.png" /></p>
</div>
<div class="section" id="orientation-and-intensity-vector">
<span id="orientation-and-intensity-vector"></span><h3>3. Orientation and Intensity Vector<a class="headerlink" href="#orientation-and-intensity-vector" title="Permalink to this headline">¶</a></h3>
<p>Angle of <a class="reference external" href="#the-best-ring">the best ring</a> from rings.csv as vector direction, and total intensity from summary.csv as color<br/>
<img alt="-" src="../../_images/map_vec.png" /></p>
</div>
<div class="section" id="elliptical-representation">
<span id="elliptical-representation"></span><h3>4. Elliptical Representation<a class="headerlink" href="#elliptical-representation" title="Permalink to this headline">¶</a></h3>
<p>Angle of <a class="reference external" href="#the-best-ring">the best ring</a> from rings.csv as ellipse orientation, total intensity from summary.csv as color, and angle sigma as ellipse size<br/>
<img alt="-" src="../../_images/map_ellipse.png" /></p>
<hr class="docutils" />
<div class="section" id="the-best-ring">
<span id="the-best-ring"></span><h4>The best ring<a class="headerlink" href="#the-best-ring" title="Permalink to this headline">¶</a></h4>
<p>These are the  ring parameters which provides the lowest fitting error. The  fitting error and angle sigma must be less than 1 in order for isotropic rings to be omitted from the angular distribution maps.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Scanning-Diffraction--How-to-use.html" class="btn btn-neutral float-right" title="How to use" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Scanning-Diffraction-(di).html" class="btn btn-neutral" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, BioCAT.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>